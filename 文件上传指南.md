# 文件上传到 Linux 服务器指南

本文档介绍如何将项目文件上传到 Linux 服务器。

## 目录

- [SCP 上传方式](#scp-上传方式)
- [其他上传方式](#其他上传方式)
- [常见问题](#常见问题)

---

## SCP 上传方式

### 方式1: 密码认证（最简单）

**适用场景**: 服务器启用了密码登录

```bash
# 基本语法
scp -r /本地路径/项目目录 用户名@服务器IP:/远程路径/

# 示例
scp -r ./top2 user@192.168.1.100:/opt/crypto-top2

# 会提示输入密码，输入后开始上传
```

**优点**: 
- 不需要额外配置
- 适合临时上传

**缺点**: 
- 每次需要输入密码
- 安全性较低

---

### 方式2: 使用 PEM 密钥文件

**适用场景**: 服务器使用 PEM 格式的 SSH 密钥（常见于 AWS EC2、阿里云 ECS 等）

```bash
# 基本语法
scp -i /path/to/your-key.pem -r /本地路径/项目目录 用户名@服务器IP:/远程路径/

# 示例（AWS EC2）
scp -i ~/Downloads/my-ec2-key.pem -r ./top2 ec2-user@ec2-xxx.compute.amazonaws.com:/opt/crypto-top2

# 示例（阿里云 ECS）
scp -i ~/Downloads/aliyun-key.pem -r ./top2 root@47.xxx.xxx.xxx:/opt/crypto-top2

# 示例（腾讯云 CVM）
scp -i ~/Downloads/tencent-key.pem -r ./top2 ubuntu@123.xxx.xxx.xxx:/opt/crypto-top2
```

**重要提示**:
- PEM 文件权限必须是 600（只有所有者可读写）
- 如果权限不对，会报错 "Permissions 0644 for 'key.pem' are too open"

**修复权限**:
```bash
chmod 600 /path/to/your-key.pem
```

**优点**: 
- 安全性高
- 无需输入密码
- 适合自动化脚本

**缺点**: 
- 需要保管好密钥文件

---

### 方式3: 使用默认 SSH 密钥

**适用场景**: 已经配置了 SSH 密钥认证

**步骤1: 生成 SSH 密钥（如果还没有）**

```bash
# 生成密钥对
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# 密钥会保存在 ~/.ssh/id_rsa（私钥）和 ~/.ssh/id_rsa.pub（公钥）
```

**步骤2: 将公钥复制到服务器**

```bash
# 方法1: 使用 ssh-copy-id（推荐）
ssh-copy-id user@server-ip

# 方法2: 手动复制
cat ~/.ssh/id_rsa.pub | ssh user@server-ip "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

**步骤3: 使用 SCP 上传（无需指定密钥）**

```bash
# 直接上传，会自动使用 ~/.ssh/id_rsa
scp -r ./top2 user@server-ip:/opt/crypto-top2
```

**优点**: 
- 配置一次，永久使用
- 安全性高
- 无需每次输入密码或指定密钥

---

### 方式4: 使用 SSH Config 配置

**适用场景**: 经常连接同一台服务器

**步骤1: 创建 SSH 配置文件**

编辑 `~/.ssh/config`:

```bash
Host myserver
    HostName 192.168.1.100
    User ubuntu
    IdentityFile ~/.ssh/my-server-key.pem
    Port 22
```

**步骤2: 使用别名上传**

```bash
# 使用配置的别名
scp -r ./top2 myserver:/opt/crypto-top2

# SSH 连接也可以使用别名
ssh myserver
```

**优点**: 
- 简化命令
- 统一管理多个服务器配置

---

## 其他上传方式

### 方式1: 使用 rsync（推荐，支持断点续传）

**基本语法**:
```bash
# 密码认证
rsync -avz --progress /本地路径/项目目录/ 用户名@服务器IP:/远程路径/

# PEM 密钥认证
rsync -avz --progress -e "ssh -i /path/to/your-key.pem" /本地路径/项目目录/ 用户名@服务器IP:/远程路径/

# 默认 SSH 密钥
rsync -avz --progress /本地路径/项目目录/ 用户名@服务器IP:/远程路径/
```

**示例**:
```bash
# 使用 PEM 密钥
rsync -avz --progress -e "ssh -i ~/Downloads/key.pem" ./top2/ ubuntu@192.168.1.100:/opt/crypto-top2/

# 使用密码
rsync -avz --progress ./top2/ user@192.168.1.100:/opt/crypto-top2/
```

**优点**: 
- 支持断点续传
- 只传输变更的文件
- 显示传输进度

---

### 方式2: 使用 tar + ssh（适合大文件）

**步骤1: 在本地打包**

```bash
cd /path/to
tar czf top2.tar.gz top2/
```

**步骤2: 上传压缩包**

```bash
# 使用密码
scp top2.tar.gz user@server:/tmp/

# 使用 PEM 密钥
scp -i ~/Downloads/key.pem top2.tar.gz user@server:/tmp/
```

**步骤3: 在服务器上解压**

```bash
# SSH 登录服务器
ssh user@server
# 或使用密钥
ssh -i ~/Downloads/key.pem user@server

# 解压
cd /opt
sudo tar xzf /tmp/top2.tar.gz
sudo chown -R $USER:$USER /opt/top2
```

**优点**: 
- 传输速度快（压缩后体积小）
- 适合大文件或网络较慢的情况

---

### 方式3: 使用 Git（推荐，适合代码）

**步骤1: 在本地创建 Git 仓库**

```bash
cd /path/to/top2
git init
git add .
git commit -m "Initial commit"
```

**步骤2: 在服务器上克隆**

```bash
# 在服务器上
cd /opt
git clone <your-repo-url> crypto-top2
```

**或者推送到远程仓库后克隆**:

```bash
# 在本地推送到 GitHub/GitLab 等
git remote add origin <your-repo-url>
git push -u origin main

# 在服务器上克隆
git clone <your-repo-url> crypto-top2
```

**优点**: 
- 版本控制
- 易于更新和维护
- 支持协作开发

---

### 方式4: 使用 FTP/SFTP 客户端

**推荐工具**:
- **FileZilla** (Windows/Mac/Linux): 免费，支持 SFTP
- **WinSCP** (Windows): 免费，功能强大
- **Cyberduck** (Mac/Windows): 免费，界面友好
- **VS Code Remote-SSH**: 直接在编辑器中上传

**使用 FileZilla 示例**:

1. 打开 FileZilla
2. 文件 → 站点管理器
3. 新建站点：
   - 协议: SFTP
   - 主机: 服务器 IP
   - 端口: 22
   - 用户名: 你的用户名
   - 密码: 你的密码（或使用密钥文件）
4. 连接后，拖拽文件上传

---

## 常见问题

### Q1: 提示 "Permission denied (publickey)"

**原因**: 服务器禁用了密码登录，只允许密钥认证

**解决方法**:
```bash
# 使用 PEM 密钥文件
scp -i /path/to/key.pem -r ./top2 user@server:/opt/

# 或配置 SSH 密钥（见方式3）
```

---

### Q2: 提示 "Permissions 0644 for 'key.pem' are too open"

**原因**: PEM 文件权限过于开放

**解决方法**:
```bash
chmod 600 /path/to/key.pem
```

---

### Q3: 上传速度很慢

**解决方法**:
1. 使用压缩方式上传（tar + gzip）
2. 使用 rsync（支持断点续传）
3. 检查网络连接
4. 考虑使用 CDN 或对象存储

---

### Q4: 上传中断怎么办

**解决方法**:
1. 使用 rsync（自动断点续传）
2. 使用 tar 压缩后上传（减少传输时间）
3. 分批次上传（先上传核心文件，再上传其他）

---

### Q5: 如何上传到需要 sudo 权限的目录

**方法1: 先上传到用户目录，再移动**

```bash
# 上传到用户目录
scp -i key.pem -r ./top2 user@server:~/

# SSH 登录后移动
ssh -i key.pem user@server
sudo mv ~/top2 /opt/
sudo chown -R user:user /opt/top2
```

**方法2: 使用 sudo 在服务器上操作**

```bash
# 上传到 /tmp
scp -i key.pem -r ./top2 user@server:/tmp/

# SSH 登录后移动
ssh -i key.pem user@server
sudo mv /tmp/top2 /opt/
sudo chown -R user:user /opt/top2
```

---

### Q6: 如何排除某些文件不上传

**使用 rsync 排除文件**:

```bash
rsync -avz --progress \
  --exclude 'node_modules' \
  --exclude '__pycache__' \
  --exclude '*.pyc' \
  --exclude '.git' \
  ./top2/ user@server:/opt/crypto-top2/
```

**或创建 .rsyncignore 文件**:

```bash
# .rsyncignore
node_modules/
__pycache__/
*.pyc
.git/
*.db
```

---

## 快速参考

### 最常用的上传命令

```bash
# 1. 使用密码（最简单）
scp -r ./top2 user@server:/opt/crypto-top2

# 2. 使用 PEM 密钥（云服务器常用）
scp -i ~/Downloads/key.pem -r ./top2 user@server:/opt/crypto-top2

# 3. 使用 rsync（推荐，支持断点续传）
rsync -avz --progress -e "ssh -i ~/Downloads/key.pem" ./top2/ user@server:/opt/crypto-top2/

# 4. 压缩后上传（大文件）
tar czf top2.tar.gz top2/
scp -i ~/Downloads/key.pem top2.tar.gz user@server:/tmp/
ssh -i ~/Downloads/key.pem user@server "cd /opt && sudo tar xzf /tmp/top2.tar.gz"
```

### 各云平台常见用户名

- **AWS EC2**: `ec2-user` (Amazon Linux) 或 `ubuntu` (Ubuntu)
- **阿里云 ECS**: `root` 或 `ecs-user`
- **腾讯云 CVM**: `ubuntu` 或 `root`
- **Azure**: `azureuser`
- **Google Cloud**: `用户名`（创建实例时指定）

---

## 总结

**推荐方式**:

1. **开发阶段**: 使用 Git（版本控制 + 易于更新）
2. **快速上传**: 使用 SCP + PEM 密钥
3. **大文件/网络慢**: 使用 tar 压缩 + SCP
4. **需要断点续传**: 使用 rsync
5. **图形界面**: 使用 FileZilla 或 WinSCP

**安全建议**:

- ✅ 使用 SSH 密钥认证（比密码更安全）
- ✅ PEM 文件权限设置为 600
- ✅ 不要将密钥文件提交到 Git
- ✅ 定期更换密钥
- ✅ 使用强密码（如果必须使用密码认证）

---

**祝上传顺利！**

