# 微服务拆分说明

## 概述

项目已从单体架构拆分为三个独立的微服务：

1. **数据管理服务** (Data Service) - 端口 8001
2. **回测服务** (Backtest Service) - 端口 8002
3. **订单服务** (Order Service) - 端口 8003

## 目录结构

```
services/
├── data_service/          # 数据管理服务
│   └── main.py           # 服务入口
├── backtest_service/      # 回测服务
│   └── main.py           # 服务入口
├── order_service/         # 订单服务
│   └── main.py           # 服务入口
└── shared/               # 共享模块
    ├── __init__.py
    └── config.py         # 共享配置
```

## 服务职责

### 1. 数据管理服务 (端口 8001)

**API端点**:
- `POST /api/download` - 下载K线数据
- `GET /api/symbols` - 查询本地交易对
- `GET /api/dates/{interval}/{symbol}` - 查询交易对数据日期
- `GET /api/kline/{interval}/{symbol}` - 获取K线数据
- `POST /api/tables/delete` - 删除所有表
- `POST /api/data-integrity` - 数据完整性检查
- `POST /api/generate-integrity-report` - 生成完整性报告
- `POST /api/generate-download-script` - 生成下载脚本
- `POST /api/download-missing-data` - 下载缺失数据
- `POST /api/recheck-problematic-symbols` - 复检问题数据

**依赖模块**:
- `download_klines.py` - 数据下载功能
- `data.py` - 数据管理和完整性检查

### 2. 回测服务 (端口 8002)

**API端点**:
- `POST /api/backtest` - 运行回测交易

**依赖模块**:
- `backtrade.py` - 回测逻辑

### 3. 订单服务 (端口 8003)

**API端点**:
- `POST /api/calculate-order` - 计算订单价格

**依赖模块**:
- `order.py` - 订单计算逻辑

## 启动服务

### 方式1：使用启动脚本（推荐）

```bash
./start-services.sh
```

### 方式2：手动启动

```bash
# 终端1：启动数据管理服务
python services/data_service/main.py

# 终端2：启动回测服务
python services/backtest_service/main.py

# 终端3：启动订单服务
python services/order_service/main.py
```

### 方式3：使用Docker Compose

```bash
docker-compose -f docker-compose.services.yml up
```

## 前端配置

前端已更新为支持多服务架构。API调用会自动路由到对应的服务：

- 数据管理相关：`http://localhost:8001`
- 回测相关：`http://localhost:8002`
- 订单计算相关：`http://localhost:8003`

### 环境变量配置

可以在 `.env.local` 文件中配置服务地址：

```env
NEXT_PUBLIC_DATA_SERVICE_URL=http://localhost:8001
NEXT_PUBLIC_BACKTEST_SERVICE_URL=http://localhost:8002
NEXT_PUBLIC_ORDER_SERVICE_URL=http://localhost:8003
```

如果设置了 `NEXT_PUBLIC_API_URL`，所有服务将使用该地址（向后兼容）。

## API文档

启动服务后，访问以下地址查看API文档：

- **数据管理服务**: http://localhost:8001/docs
- **回测服务**: http://localhost:8002/docs
- **订单服务**: http://localhost:8003/docs

## 共享资源

- **数据库**: 所有服务共享同一个SQLite数据库 (`db/crypto_data.db`)
- **共享模块**: `services/shared/` 目录包含共享的配置和工具函数

## 迁移说明

### 从单体服务迁移

1. **停止旧服务**:
   ```bash
   # 如果使用Docker
   docker-compose down
   
   # 如果直接运行
   pkill -f "api_server.py"
   ```

2. **启动新服务**:
   ```bash
   ./start-services.sh
   ```

3. **更新前端**:
   前端代码已自动更新，无需修改。

### 向后兼容

- 如果设置了 `NEXT_PUBLIC_API_URL` 环境变量，所有服务将使用该地址
- 旧的 `api_server.py` 仍然可以运行（端口8000），但建议迁移到新架构

## 优势

1. **独立扩展**: 每个服务可以独立扩展，根据负载调整实例数量
2. **独立部署**: 服务更新互不影响
3. **资源隔离**: 可以为不同服务设置不同的资源限制
4. **故障隔离**: 一个服务故障不会影响其他服务
5. **开发协作**: 不同团队可以独立开发和测试各自的服务

## 注意事项

1. **数据库共享**: 所有服务共享同一个数据库，需要注意并发访问
2. **端口冲突**: 确保端口 8001、8002、8003 未被占用
3. **CORS配置**: 前端需要能够访问所有三个服务的端口
4. **服务依赖**: 回测服务依赖数据管理服务的数据，确保数据服务先启动

