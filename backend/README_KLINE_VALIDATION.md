# 基于K线数据的CSV验证模块使用说明

## 概述

`validate_csv_with_kline.py` 模块用于验证CSV文件中的交易记录是否能在实际的K线数据中实现。该模块会检查：

- ✅ 建仓时间点的价格是否能在对应K线数据中找到
- ✅ 建仓价是否在K线的价格范围内（开盘价、最高价、最低价、收盘价之间）
- ✅ 平仓时间点的价格是否能在对应K线数据中找到
- ✅ 平仓价是否在K线的价格范围内

## 功能特性

- 🔍 **多时间粒度支持**: 优先使用5分钟K线，如果没有则使用小时K线
- 📊 **价格范围验证**: 验证价格是否在K线的最高价和最低价之间
- ⏰ **时间匹配**: 精确匹配到对应时间点的K线数据
- 🔄 **容差处理**: 允许小的价格差异（0.0001）和时间差异
- 📝 **详细报告**: 生成包含问题详情的验证报告

## 使用方法

### 1. 命令行使用

```bash
# 基本用法
python backend/validate_csv_with_kline.py data/backtrade_records/buy_surge_backtest_report_20260123_122643.csv --print

# 指定报告输出路径
python backend/validate_csv_with_kline.py data/backtrade_records/buy_surge_backtest_report_20260123_122643.csv \
    --output kline_validation_report.txt
```

### 2. Python代码中使用

```python
from validate_csv_with_kline import KlineCSVValidator

# 创建验证器
validator = KlineCSVValidator('data/backtrade_records/buy_surge_backtest_report_20260123_122643.csv')

# 执行验证
results = validator.validate()

# 生成报告
report = validator.generate_report()
print(report)

# 保存报告
report_path = validator.save_report()
```

## 验证逻辑

### 1. 建仓验证

根据回测程序 `hm20260121.py` 的逻辑：

1. **K线数据源**：使用小时K线（`1h`），表名格式：`K1h{symbol}`
2. **建仓价格逻辑**：
   - 信号价格：信号时间点的小时K线 `close`（收盘价）
   - 建仓价格：基于信号 `close` 计算的目标回调价格
     - `target_price = signal_close * (1 + target_drop_pct)`
     - 当小时K线的 `low`（最低价）≤ `target_price` 时建仓
   - 建仓价格 = `target_price`（目标回调价格）
3. **验证方式**：
   - 查找对应时间点的小时K线
   - 验证建仓价是否在K线的 `[low, high]` 范围内（允许0.0001的容差）

### 2. 平仓验证

根据回测程序的平仓逻辑：

1. **K线数据源**：使用小时K线（`1h`）
2. **平仓价格逻辑**（根据平仓原因）：
   - **止盈**（`take_profit`）：
     - 触发条件：小时K线的 `high` >= 止盈阈值价格
     - 平仓价格：使用止盈阈值价格（`tp_price`），不是直接用 `high`
     - 验证：平仓价应在 `[low, high]` 范围内（因为阈值价格 <= high）
   
   - **止损**（`stop_loss`）：
     - 触发条件：小时K线的 `low` <= 止损阈值价格
     - 平仓价格：使用止损阈值价格（`sl_price`），不是直接用 `low`
     - 验证：平仓价应在 `[low, high]` 范围内（因为阈值价格 >= low）
   
   - **顶级交易者止损**（`stop_loss_trader`）：
     - 平仓价格：使用当前小时K线的 `close`（收盘价）
     - 验证：平仓价应接近 `close`（允许0.1%的容差）
   
   - **超时平仓**（`max_hold_time`/`observing_timeout`）：
     - 平仓价格：使用当前小时K线的 `close`（收盘价）
     - 验证：平仓价应接近 `close`（允许0.1%的容差）
   
   - **其他原因**：检查是否在 `[low, high]` 范围内

3. **验证方式**：
   - 止盈/止损：验证平仓价是否在K线的 `[low, high]` 范围内（因为使用的是阈值价格）
   - 顶级交易者止损/超时平仓：验证平仓价是否接近 `close`（允许0.1%的容差）
   - 其他：验证是否在 `[low, high]` 范围内

## 验证结果

验证结果包含以下信息：

- **total_records**: CSV文件中的记录总数
- **validated_records**: 已验证的记录数
- **entry_price_valid**: 建仓价验证通过的记录数
- **entry_price_invalid**: 建仓价验证失败的记录数
- **exit_price_valid**: 平仓价验证通过的记录数
- **exit_price_invalid**: 平仓价验证失败的记录数
- **entry_price_issues**: 建仓验证问题的详细信息列表
- **exit_price_issues**: 平仓验证问题的详细信息列表
- **errors**: 验证过程中发生的错误列表

## 报告格式

验证报告包含：

1. **基本统计**: 记录数量统计
2. **建仓验证统计**: 建仓验证通过率和失败数
3. **平仓验证统计**: 平仓验证通过率和失败数
4. **建仓问题详情**: 建仓验证失败的记录详情（包括K线数据、价格范围等）
5. **平仓问题详情**: 平仓验证失败的记录详情
6. **错误信息**: 验证过程中的错误
7. **总结**: 验证结果总结

## 示例输出

```
================================================================================
基于K线数据的CSV文件验证报告
================================================================================
CSV文件: data/backtrade_records/buy_surge_backtest_report_20260123_122643.csv
生成时间: 2026-01-23 12:30:00

基本统计:
  总记录数: 187
  已验证记录数: 187

建仓验证统计:
  验证通过: 185 条
  验证失败: 2 条
  通过率: 98.9%

平仓验证统计:
  验证通过: 150 条
  验证失败: 5 条
  通过率: 96.8%

⚠️  建仓验证问题 (2 条):
  15. TRUTHUSDT:
     建仓时间: 2025-12-01 14:00:00
     建仓价: 0.016595
     K线时间: 2025-12-01 14:00:00
     K线范围: [0.016500, 0.016800]
     问题: 价格在K线范围内 [0.016500, 0.016800]

✅ 验证通过：所有价格都能在实际K线数据中找到
================================================================================
```

## 注意事项

1. **K线数据要求**: 
   - 需要确保数据库中有所需交易对的小时K线数据表（`K1h{symbol}`）
   - 如果某个时间点的K线数据不存在，验证会失败
   - 验证模块优先使用小时K线，与回测程序逻辑一致

2. **时间精度**:
   - 小时K线：匹配到小时精度（例如：14:00:00 匹配到 14:00 的K线）
   - 如果精确匹配失败，会查找最接近的K线（时间差不超过60分钟）

3. **价格容差**:
   - 允许0.0001的价格差异
   - 建仓价：必须在K线的 `[low, high]` 范围内
   - 平仓价：根据平仓原因验证是否接近对应的价格字段（high/low/close）

4. **平仓原因识别**:
   - 验证模块会根据CSV中的"平仓原因"字段自动识别平仓类型
   - 支持的平仓原因关键词：
     - `take_profit` / `profit` → 使用 `high` 验证
     - `stop_loss` / `loss` → 使用 `low` 验证
     - `timeout` / `max_hold` / `observing` → 使用 `close` 验证
     - 其他 → 使用 `[low, high]` 范围验证

5. **未平仓交易**:
   - 如果交易记录中没有平仓信息（平仓日期或平仓价为空），会跳过平仓验证

## 故障排查

### 问题1: 找不到K线数据
- 检查数据库中是否存在对应的K线数据表
- 确认交易对名称是否正确
- 检查K线数据的时间范围是否覆盖交易时间

### 问题2: 价格验证失败
- 检查建仓/平仓时间是否正确
- 确认价格是否在K线的合理范围内
- 考虑滑点因素（实际交易价格可能与K线价格有差异）

### 问题3: 数据库连接失败
- 检查数据库配置（`backend/services/shared/config.py`）
- 确保数据库服务正在运行
- 检查环境变量设置

## 扩展开发

如需修改验证逻辑，可以：

1. 修改 `find_kline_at_time()` 方法调整K线查找逻辑
2. 修改 `validate_price_in_kline()` 方法调整价格验证逻辑
3. 修改容差值以适应不同的交易对

## 相关文件

- `backend/validate_csv_with_kline.py`: 验证模块主文件
- `backend/data.py`: K线数据获取模块
- `backend/hm20260121.py`: 生成CSV的回测脚本
- `backend/db.py`: 数据库连接配置
