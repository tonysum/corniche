# hm1.py vs hm1-old.py 对比分析

## 📊 主要差异总结

### 1. 数据源和数据库访问方式

| 特性 | hm1.py (新版本) | hm1-old.py (旧版本) |
|------|----------------|-------------------|
| 数据库连接 | `sqlite3.connect(CRYPTO_DB_PATH)` | `SQLAlchemy engine` |
| 表名格式 | `DailyKline_{symbol}`, `HourlyKline_{symbol}` | `K1d{symbol}`, `K1h{symbol}` |
| 数据获取 | 直接SQL查询 | 使用 `get_local_symbols()`, `get_local_kline_data()` |
| 查询方式 | 原生SQL | SQLAlchemy `text()` 查询 |

### 2. 信号检测逻辑（核心差异）

**hm1.py (新版本)**:
- 方法：`get_daily_1hour_surge_signals()`
- 逻辑：检测**某小时内**买量是否超过**昨日平均小时买量**的倍数
- 计算公式：`某小时买量 >= 昨日总买量 / 24 × 阈值(2倍)`
- 特点：更精细，基于小时级别信号

**hm1-old.py (旧版本)**:
- 方法：`get_daily_buy_surge_coins()`
- 逻辑：检测**当日总买量** vs **昨日总买量**的倍数
- 计算公式：`今日总买量 >= 昨日总买量 × 阈值(20倍)`
- 特点：基于日级别信号

### 3. 买量暴涨阈值

| 版本 | 默认阈值 | 倍数上限 |
|------|---------|---------|
| hm1.py | 2倍（小时买量 vs 昨日平均小时买量） | 3倍（默认，可调至10倍） |
| hm1-old.py | 20倍（日买量 vs 昨日日买量） | 无上限 |

### 4. 等待回调策略

**hm1.py**:
```python
wait_drop_pct_config = [
    (3, -0.15),     # 2-3倍：等待15%回调（实际是5%）
    (5, -0.04),     # 3-5倍：等待4%回调
    (10, -0.03),   # 5-10倍：等待3%回调
    (9999, -0.01), # 10倍以上：等待2%回调
]
```

**hm1-old.py**:
```python
wait_drop_pct_config = [
    (30, -0.03),   # 20-30倍：等待3%
    (60, -0.04),   # 30-60倍：等待4%
    (100, -0.05),  # 60-100倍：等待5%
    (9999, -0.06), # 100倍以上：等待6%
]
```

### 5. 动态止盈机制

**hm1.py (更复杂)**:
- **基础止盈**：8.5%
- **判定窗口**：2小时 + 12小时双重判断
- **判定方式**：
  1. 2小时内60%的5分钟K线收盘价涨幅>1.5%
  2. 12小时涨幅 >= 2.5%
- **动态加成**（按买量倍数分档）：
  - 2-3倍：+11% → 总止盈19.5%
  - 3-6倍：+8% → 总止盈16.5%
  - 6-10倍：+5% → 总止盈13.5%
- **数据源**：使用5分钟K线数据 (`Kline5m_{symbol}`)

**hm1-old.py (较简单)**:
- **基础止盈**：20%
- **判定窗口**：仅2小时
- **判定方式**：统计2小时内价格相对建仓价的位置
  - 80%时间在+10%以上 → 止盈提高到30%
  - 80%时间在+2%~+10% → 止盈提高到25%
- **数据源**：使用小时K线数据

### 6. 补仓机制

| 特性 | hm1.py | hm1-old.py |
|------|--------|-----------|
| 补仓金额 | 当前资金 × 15%（可独立配置） | 等于首次建仓数量 |
| 首次建仓 | 当前资金 × 5% | 当前资金 × 5% |
| 补仓后检查 | 立即检查止盈/止损 | 立即检查止盈/止损 |

### 7. 止损机制

| 特性 | hm1.py | hm1-old.py |
|------|--------|-----------|
| 触发条件 | 补仓后基于新平均成本下跌18% | 补仓后基于新平均成本下跌18% |
| 首次建仓 | 不设止损 | 不设止损 |
| 监控方式 | 小时K线最低价(low) | 小时K线最低价(low) |

### 8. 持仓限制

| 特性 | hm1.py | hm1-old.py |
|------|--------|-----------|
| 最大持仓时间 | 68小时（约2.8天） | 72小时（3天） |
| 最大持仓数量 | 10个（`max_daily_positions`） | 10个（硬编码） |

### 9. 信号记录和反馈

**hm1.py**:
- ✅ 有 `signal_records` 列表记录所有发现的信号
- ✅ 生成信号反馈CSV (`buy_surge_signal_feedback_{timestamp}.csv`)
- ✅ 记录信号状态：pending, entered, timeout, unfilled
- ✅ 可以追踪"发现信号但未成交"的情况

**hm1-old.py**:
- ❌ 无信号记录机制
- ❌ 只记录已建仓的交易

### 10. CSV报告生成

**hm1.py**:
- 生成两个CSV文件：
  1. 交易详细报告（包含更多字段）
  2. 信号反馈报告（包含未成交信号）
- 字段更丰富：包含建仓具体时间、平仓具体时间、持仓小时数、2小时/24小时最大涨幅、动态止盈阈值等

**hm1-old.py**:
- 只生成一个CSV文件：交易详细报告
- 字段较少：基本交易信息

### 11. 代码结构和功能

**hm1.py 新增功能**:
- ✅ `check_signal_surge()`: 检查信号触发前1小时是否暴涨（过滤机制）
- ✅ `get_daily_1hour_surge_signals()`: 小时级别信号检测
- ✅ `get_all_symbols()`: 交易对列表缓存
- ✅ `get_latest_5m_close()`: 获取最新5分钟收盘价（用于浮盈亏）
- ✅ `get_5m_closes_in_window()`: 获取时间窗口内的5分钟K线
- ✅ `_update_signal_record()`: 更新信号记录状态
- ✅ `generate_signal_csv_report()`: 生成信号反馈CSV

**hm1-old.py 特有**:
- ✅ 使用项目标准的数据访问函数 (`get_local_symbols`, `get_local_kline_data`)
- ✅ 使用SQLAlchemy进行数据库操作

### 12. 资金管理

**hm1.py**:
- 复利模式：基于当前资金余额的比例建仓
- 建仓时扣除资金，平仓时返还本金+盈亏
- 有爆仓保护：资金亏损超过80%停止交易

**hm1-old.py**:
- 类似复利模式
- 无明确的爆仓保护机制

### 13. 执行价和顺序

**hm1.py**:
- 使用"阈值价"成交，而不是直接用high/low
- 同一根K线同时触发止损与止盈时，按"先止损后止盈"（更保守）
- 补仓后同小时不允许止盈（避免过度乐观）

**hm1-old.py**:
- 使用high/low直接成交
- 补仓后同小时可以止盈

## 🎯 核心策略差异总结

### hm1.py 的策略特点：
1. **更精细的信号检测**：基于小时级别买量暴涨，而非日级别
2. **更低的阈值**：2倍 vs 20倍，能捕捉更多机会
3. **更保守的止盈**：基础8.5% vs 20%，但动态止盈可提高到19.5%
4. **更复杂的动态止盈**：双重判断机制（2小时+12小时），使用5分钟K线
5. **更完善的信号追踪**：记录所有信号，包括未成交的

### hm1-old.py 的策略特点：
1. **日级别信号检测**：基于日K线总买量对比
2. **高阈值**：20倍，信号更少但可能更"强势"
3. **更高的基础止盈**：20%，但动态止盈机制较简单
4. **使用项目标准数据访问**：更符合项目架构

## 📝 建议

1. **如果追求更多交易机会**：使用 hm1.py（2倍阈值，小时级别信号）
2. **如果追求更稳健的信号**：使用 hm1-old.py（20倍阈值，日级别信号）
3. **如果需要详细信号追踪**：使用 hm1.py（有信号反馈表）
4. **如果项目使用SQLAlchemy标准**：hm1-old.py 更符合架构
