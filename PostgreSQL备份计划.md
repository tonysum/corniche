# PostgreSQL 备份计划指南

## 备份策略概述

PostgreSQL 备份策略应该根据数据重要性、更新频率和恢复时间目标（RTO）和恢复点目标（RPO）来制定。

## 备份类型

### 1. 逻辑备份（pg_dump / pg_dumpall）

**优点：**
- 可移植性强，可在不同版本间恢复
- 可以选择性备份特定数据库或表
- 备份文件可读（SQL 格式）
- 适合小到中型数据库

**缺点：**
- 备份和恢复速度较慢
- 需要独占锁（pg_dump 使用共享锁，影响较小）

**适用场景：**
- 数据库 < 100GB
- 需要跨版本迁移
- 需要选择性备份
- 开发/测试环境

### 2. 物理备份（文件系统级备份）

**优点：**
- 备份和恢复速度快
- 可以备份整个集群
- 支持增量备份（WAL 归档）

**缺点：**
- 必须与 PostgreSQL 版本匹配
- 需要停止数据库或使用连续归档
- 备份文件较大

**适用场景：**
- 大型数据库（> 100GB）
- 生产环境
- 需要快速恢复

### 3. 连续归档（WAL 归档）

**优点：**
- 可以实现时间点恢复（PITR）
- 最小化数据丢失
- 支持热备份

**缺点：**
- 需要额外的存储空间
- 配置较复杂
- 需要定期清理旧 WAL 文件

**适用场景：**
- 关键生产环境
- 需要零数据丢失
- 需要时间点恢复

## 推荐的备份策略

### 策略1：小型数据库（< 50GB）

```
每日全量备份（逻辑备份）
├── 保留最近 7 天的备份
├── 每周保留一个备份（保留 4 周）
└── 每月保留一个备份（保留 12 个月）
```

**备份频率：**
- 每日：凌晨 2:00 执行
- 每周：周日保留周备份
- 每月：1号保留月备份

### 策略2：中型数据库（50GB - 500GB）

```
每日全量备份 + WAL 归档
├── 每日全量备份（逻辑备份）
├── WAL 归档（每 15 分钟）
├── 保留最近 7 天的全量备份
├── 保留最近 30 天的 WAL 归档
└── 每月保留一个备份（保留 12 个月）
```

**备份频率：**
- 每日全量：凌晨 2:00
- WAL 归档：连续归档模式
- 周备份：保留 4 周
- 月备份：保留 12 个月

### 策略3：大型数据库（> 500GB）

```
物理备份 + WAL 归档
├── 每周全量物理备份
├── 每日增量备份（WAL 归档）
├── WAL 归档（连续归档）
├── 保留最近 4 周的全量备份
├── 保留最近 90 天的 WAL 归档
└── 每月保留一个备份（保留 12 个月）
```

**备份频率：**
- 每周全量：周日凌晨 2:00
- WAL 归档：连续归档模式
- 月备份：保留 12 个月

## 备份计划实施步骤

### 步骤1：评估需求

1. **数据重要性**
   - 关键数据：需要每日备份 + WAL 归档
   - 一般数据：每日备份即可
   - 临时数据：可考虑不备份

2. **更新频率**
   - 高频更新（每分钟）：需要 WAL 归档
   - 中频更新（每小时）：每日备份 + WAL 归档
   - 低频更新（每天）：每日备份即可

3. **恢复时间目标（RTO）**
   - RTO < 1 小时：物理备份 + WAL 归档
   - RTO < 4 小时：逻辑备份 + WAL 归档
   - RTO > 4 小时：每日逻辑备份

4. **恢复点目标（RPO）**
   - RPO < 15 分钟：WAL 归档
   - RPO < 1 小时：每日备份 + WAL 归档
   - RPO < 24 小时：每日备份

### 步骤2：配置备份存储

**本地存储：**
- 优点：快速访问
- 缺点：单点故障风险
- 建议：仅用于临时备份

**网络存储（NFS/SMB）：**
- 优点：集中管理
- 缺点：网络依赖
- 建议：用于短期备份

**云存储（S3/OSS）：**
- 优点：高可用、可扩展
- 缺点：需要网络、可能有费用
- 建议：用于长期备份

**磁带/外部硬盘：**
- 优点：离线安全
- 缺点：访问不便
- 建议：用于归档备份

### 步骤3：设置备份目录结构

```
/backup/postgresql/
├── daily/           # 每日备份
│   ├── 2025-01-15/
│   ├── 2025-01-16/
│   └── ...
├── weekly/          # 每周备份
│   ├── 2025-W02/
│   ├── 2025-W03/
│   └── ...
├── monthly/         # 每月备份
│   ├── 2025-01/
│   ├── 2025-02/
│   └── ...
└── wal/             # WAL 归档
    ├── 000000010000000000000001
    ├── 000000010000000000000002
    └── ...
```

### 步骤4：配置 PostgreSQL 归档（如需要）

编辑 `postgresql.conf`：

```conf
# 启用 WAL 归档
wal_level = replica
archive_mode = on
archive_command = 'cp %p /backup/postgresql/wal/%f'

# 或使用自定义脚本
archive_command = '/opt/local/bin/pg_archive.sh %p %f'
```

### 步骤5：创建备份脚本

见 `pg_backup.sh` 脚本（下文提供）

### 步骤6：设置定时任务

使用 cron 或 launchd（macOS）：

```bash
# 每日备份（凌晨 2:00）
0 2 * * * /path/to/pg_backup.sh daily

# 每周备份（周日凌晨 3:00）
0 3 * * 0 /path/to/pg_backup.sh weekly

# 每月备份（1号凌晨 4:00）
0 4 1 * * /path/to/pg_backup.sh monthly
```

### 步骤7：备份验证

1. **定期测试恢复**
   - 每月至少测试一次完整恢复
   - 验证备份文件完整性
   - 测试时间点恢复（如果使用 WAL）

2. **监控备份状态**
   - 检查备份是否成功
   - 监控备份文件大小
   - 检查磁盘空间

3. **告警设置**
   - 备份失败告警
   - 磁盘空间不足告警
   - 备份文件异常告警

## 备份保留策略

### 3-2-1 备份原则

- **3** 份数据副本
- **2** 种不同的存储介质
- **1** 份离线备份

### 保留时间表

| 备份类型 | 保留时间 | 存储位置 |
|---------|---------|---------|
| 每日备份 | 7 天 | 本地 + 网络存储 |
| 每周备份 | 4 周 | 网络存储 + 云存储 |
| 每月备份 | 12 个月 | 云存储 + 离线存储 |
| WAL 归档 | 30-90 天 | 网络存储 |

## 恢复测试计划

### 测试频率

- **完整恢复测试**：每月一次
- **时间点恢复测试**：每季度一次
- **灾难恢复演练**：每年一次

### 测试步骤

1. 在测试环境恢复备份
2. 验证数据完整性
3. 测试应用连接
4. 记录恢复时间
5. 更新恢复文档

## 监控和告警

### 监控指标

- 备份执行时间
- 备份文件大小
- 备份成功率
- 磁盘使用率
- WAL 归档延迟

### 告警规则

- 备份失败：立即告警
- 备份文件大小异常：告警
- 磁盘使用率 > 80%：警告
- 磁盘使用率 > 90%：严重告警
- WAL 归档延迟 > 1 小时：告警

## 备份脚本示例

见 `pg_backup.sh` 和 `pg_restore.sh`（下文提供）

## 最佳实践

1. **自动化备份**
   - 使用 cron/launchd 自动执行
   - 减少人为错误

2. **备份加密**
   - 敏感数据备份加密
   - 使用 GPG 或加密文件系统

3. **备份压缩**
   - 使用 gzip/bzip2 压缩
   - 节省存储空间

4. **备份验证**
   - 定期测试恢复
   - 验证备份完整性

5. **文档化**
   - 记录备份流程
   - 记录恢复步骤
   - 更新变更日志

6. **权限管理**
   - 限制备份文件访问权限
   - 使用专用备份用户

7. **监控告警**
   - 设置备份失败告警
   - 监控存储空间

8. **定期审查**
   - 每月审查备份策略
   - 根据业务变化调整

## 常见问题

### Q1: 备份需要多长时间？

A: 取决于数据库大小和备份类型：
- 逻辑备份：约 10-50 MB/s
- 物理备份：约 50-200 MB/s
- 增量备份（WAL）：几乎实时

### Q2: 备份会影响性能吗？

A: 
- `pg_dump`：使用共享锁，影响较小
- 物理备份：需要短暂锁定
- WAL 归档：几乎无影响

### Q3: 如何备份大数据库？

A: 
- 使用物理备份
- 使用并行备份（pg_dump -j）
- 使用流式备份

### Q4: 备份文件应该存储在哪里？

A: 
- 本地：快速访问，用于短期备份
- 网络存储：集中管理，用于中期备份
- 云存储：高可用，用于长期备份
- 离线存储：安全，用于归档备份

### Q5: 如何验证备份？

A: 
- 定期恢复测试
- 检查备份文件大小
- 使用 `pg_restore -l` 列出内容
- 验证校验和

## 参考资源

- [PostgreSQL 官方备份文档](https://www.postgresql.org/docs/current/backup.html)
- [pg_dump 文档](https://www.postgresql.org/docs/current/app-pgdump.html)
- [连续归档和时间点恢复](https://www.postgresql.org/docs/current/continuous-archiving.html)
