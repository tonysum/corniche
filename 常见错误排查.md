# 常见错误排查指南

本文档列出安装和运行过程中可能遇到的常见错误及解决方法。

## 目录

- [Docker 相关错误](#docker-相关错误)
- [Python 相关错误](#python-相关错误)
- [Node.js 相关错误](#nodejs-相关错误)
- [数据库相关错误](#数据库相关错误)
- [网络和端口错误](#网络和端口错误)
- [权限相关错误](#权限相关错误)

---

## Docker 相关错误

### 错误1: "docker: command not found"

**原因**: Docker 未安装或未添加到 PATH

**解决方法**:
```bash
# 检查 Docker 是否安装
which docker

# 如果未安装，参考安装指南安装 Docker
# Ubuntu/Debian:
sudo apt-get update
sudo apt-get install -y docker.io docker-compose

# 启动 Docker
sudo systemctl start docker
sudo systemctl enable docker
```

---

### 错误2: "permission denied while trying to connect to the Docker daemon socket"

**原因**: 当前用户没有 Docker 权限

**解决方法**:
```bash
# 方法1: 将用户添加到 docker 组
sudo usermod -aG docker $USER
newgrp docker

# 方法2: 使用 sudo（不推荐）
sudo docker compose up -d

# 验证
docker ps
```

---

### 错误3: "Cannot connect to the Docker daemon"

**原因**: Docker 服务未启动

**解决方法**:
```bash
# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 检查状态
sudo systemctl status docker
```

---

### 错误4: "Error response from daemon: Get https://registry-1.docker.io/v2/: net/http: request canceled"

**原因**: 网络连接问题，无法访问 Docker Hub

**解决方法**:
```bash
# 方法1: 配置 Docker 镜像加速器（国内服务器）
# 参考 Docker镜像加速配置.md

# 方法2: 使用国内镜像源配置
docker compose -f docker-compose.cn.yml up -d --build

# 方法3: 检查网络连接
ping registry-1.docker.io
```

---

### 错误5: "ERROR: failed to solve: failed to fetch"

**原因**: 构建镜像时下载依赖失败

**解决方法**:
```bash
# 方法1: 清理构建缓存后重试
docker compose build --no-cache

# 方法2: 检查网络连接
ping pypi.org
ping registry.npmjs.org

# 方法3: 使用国内镜像源（后端）
# 修改 Dockerfile.backend，使用国内 pip 源
```

---

### 错误6: "port is already allocated"

**原因**: 端口被占用

**解决方法**:
```bash
# 检查端口占用
sudo netstat -tulpn | grep :8000
sudo netstat -tulpn | grep :3000

# 或使用 ss
sudo ss -tulpn | grep :8000

# 停止占用端口的进程
sudo kill -9 <PID>

# 或修改 docker-compose.yml 中的端口映射
# 将 "8000:8000" 改为 "8001:8000"
```

---

## Python 相关错误

### 错误1: "python3.11: command not found"

**原因**: Python 3.11 未安装

**解决方法**:
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y python3.11 python3.11-venv python3-pip

# CentOS/RHEL
sudo yum install -y python3.11 python3-pip

# 验证
python3.11 --version
```

---

### 错误2: "ModuleNotFoundError: No module named 'xxx'"

**原因**: Python 依赖包未安装

**解决方法**:
```bash
# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 如果某个包安装失败，单独安装
pip install <package-name>

# 检查已安装的包
pip list
```

---

### 错误3: "ERROR: Could not find a version that satisfies the requirement"

**原因**: 包版本不兼容或网络问题

**解决方法**:
```bash
# 方法1: 升级 pip
pip install --upgrade pip

# 方法2: 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 方法3: 检查 Python 版本
python3 --version  # 需要 Python 3.11+

# 方法4: 检查 requirements.txt 中的包名是否正确
```

---

### 错误4: "ImportError: cannot import name 'xxx'"

**原因**: 模块导入错误，可能是版本不兼容

**解决方法**:
```bash
# 检查已安装的版本
pip show <package-name>

# 重新安装特定版本
pip install --force-reinstall <package-name>==<version>

# 检查 Python 路径
python3 -c "import sys; print(sys.path)"
```

---

### 错误5: "sqlalchemy.exc.OperationalError: unable to open database file"

**原因**: 数据库文件路径错误或权限问题

**解决方法**:
```bash
# 检查数据库目录
ls -la db/

# 创建数据库目录
mkdir -p db
chmod -R 755 db

# 检查文件权限
ls -la db/crypto_data.db

# 修复权限
chmod 644 db/crypto_data.db
chown $USER:$USER db/crypto_data.db
```

---

## Node.js 相关错误

### 错误1: "node: command not found"

**原因**: Node.js 未安装

**解决方法**:
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 验证
node --version
npm --version
```

---

### 错误2: "npm ERR! code EACCES"

**原因**: npm 权限问题

**解决方法**:
```bash
# 方法1: 使用 sudo（不推荐）
sudo npm install

# 方法2: 修复 npm 权限
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 方法3: 使用 nvm（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

---

### 错误3: "npm ERR! network timeout"

**原因**: 网络连接问题

**解决方法**:
```bash
# 方法1: 使用国内镜像源
npm config set registry https://registry.npmmirror.com

# 方法2: 增加超时时间
npm install --timeout=60000

# 方法3: 检查网络连接
ping registry.npmjs.org
```

---

### 错误4: "Error: Cannot find module 'xxx'"

**原因**: Node.js 依赖未安装

**解决方法**:
```bash
# 进入前端目录
cd frontend

# 清理并重新安装
rm -rf node_modules package-lock.json
npm install

# 如果特定模块缺失
npm install <module-name>
```

---

### 错误5: "next: command not found"

**原因**: Next.js 未正确安装

**解决方法**:
```bash
cd frontend

# 重新安装依赖
npm install

# 检查 package.json
cat package.json

# 手动安装 Next.js
npm install next@16.1.1
```

---

## 数据库相关错误

### 错误1: "sqlite3.OperationalError: database is locked"

**原因**: 数据库文件被锁定（可能有其他进程在使用）

**解决方法**:
```bash
# 检查是否有其他进程在使用数据库
lsof db/crypto_data.db

# 停止相关进程
kill -9 <PID>

# 检查文件权限
ls -la db/crypto_data.db

# 重启服务
docker compose restart backend
# 或
sudo systemctl restart crypto-backend
```

---

### 错误2: "no such table: xxx"

**原因**: 数据库表不存在

**解决方法**:
```bash
# 初始化数据库
python3 init_db.py

# 或进入 Python 环境
python3
>>> from db import create_table
>>> create_table()
```

---

### 错误3: "disk I/O error"

**原因**: 磁盘空间不足或磁盘错误

**解决方法**:
```bash
# 检查磁盘空间
df -h

# 检查磁盘错误
sudo fsck /dev/sda1  # 替换为实际磁盘

# 清理空间
docker system prune -a  # Docker 方式
# 或
rm -rf __pycache__ *.pyc  # 清理 Python 缓存
```

---

## 网络和端口错误

### 错误1: "Connection refused"

**原因**: 服务未启动或端口未监听

**解决方法**:
```bash
# 检查服务状态
docker compose ps  # Docker 方式
sudo systemctl status crypto-backend  # 直接安装方式

# 检查端口监听
sudo netstat -tulpn | grep :8000
sudo netstat -tulpn | grep :3000

# 查看日志
docker compose logs backend  # Docker 方式
sudo journalctl -u crypto-backend -n 50  # 直接安装方式
```

---

### 错误2: "Address already in use"

**原因**: 端口被占用

**解决方法**:
```bash
# 查找占用端口的进程
sudo lsof -i :8000
sudo lsof -i :3000

# 停止占用进程
sudo kill -9 <PID>

# 或修改端口配置
# 编辑 docker-compose.yml 或 systemd 服务文件
```

---

### 错误3: "Failed to connect to API"

**原因**: 前端无法连接到后端

**解决方法**:
```bash
# 检查后端是否运行
curl http://localhost:8000/api/health

# 检查前端环境变量
cd frontend
cat .env.local
# 确保 NEXT_PUBLIC_API_URL 正确

# 检查防火墙
sudo ufw status
sudo firewall-cmd --list-all
```

---

## 权限相关错误

### 错误1: "Permission denied"

**原因**: 文件或目录权限不足

**解决方法**:
```bash
# 检查权限
ls -la db/
ls -la backtrade_records/

# 修复权限
chmod -R 755 db
chmod -R 755 backtrade_records
chown -R $USER:$USER db backtrade_records

# 检查当前用户
whoami
```

---

### 错误2: "cannot create directory: Permission denied"

**原因**: 目录创建权限不足

**解决方法**:
```bash
# 创建目录
sudo mkdir -p /opt/crypto-top2
sudo chown -R $USER:$USER /opt/crypto-top2

# 或使用用户目录
mkdir -p ~/crypto-top2
```

---

## 通用排查步骤

### 1. 查看详细日志

**Docker 方式**:
```bash
# 查看所有日志
docker compose logs

# 查看特定服务日志
docker compose logs backend
docker compose logs frontend

# 实时查看日志
docker compose logs -f
```

**直接安装方式**:
```bash
# systemd 日志
sudo journalctl -u crypto-backend -f
sudo journalctl -u crypto-frontend -f

# 系统日志
sudo dmesg | tail -50
```

---

### 2. 检查服务状态

**Docker 方式**:
```bash
docker compose ps
docker stats
```

**直接安装方式**:
```bash
sudo systemctl status crypto-backend
sudo systemctl status crypto-frontend
```

---

### 3. 进入容器/环境调试

**Docker 方式**:
```bash
# 进入后端容器
docker compose exec backend bash

# 进入前端容器
docker compose exec frontend sh

# 在容器内检查
python3 --version
pip list
ls -la /app
```

**直接安装方式**:
```bash
# 激活虚拟环境
source venv/bin/activate

# 检查 Python 环境
python3 --version
pip list

# 测试导入
python3 -c "import fastapi; print('OK')"
```

---

### 4. 验证网络连接

```bash
# 检查本地服务
curl http://localhost:8000/api/health

# 检查外部网络
ping google.com
ping pypi.org

# 检查 DNS
nslookup pypi.org
```

---

### 5. 检查系统资源

```bash
# 检查内存
free -h

# 检查磁盘空间
df -h

# 检查 CPU
top
htop
```

---

## 获取帮助

如果以上方法都无法解决问题，请提供以下信息：

1. **完整的错误信息**（包括堆栈跟踪）
2. **操作系统版本**: `cat /etc/os-release`
3. **Python 版本**: `python3 --version`
4. **Node.js 版本**: `node --version`
5. **Docker 版本**（如果使用）: `docker --version`
6. **安装方式**: Docker 或直接安装
7. **执行的具体命令**
8. **相关日志文件内容**

---

## 快速诊断命令

```bash
# 一键诊断脚本
echo "=== 系统信息 ==="
uname -a
cat /etc/os-release

echo "=== Python 环境 ==="
python3 --version
which python3

echo "=== Node.js 环境 ==="
node --version
npm --version

echo "=== Docker 环境 ==="
docker --version 2>/dev/null || echo "Docker 未安装"
docker compose version 2>/dev/null || echo "Docker Compose 未安装"

echo "=== 端口占用 ==="
sudo netstat -tulpn | grep -E ':(8000|3000)'

echo "=== 磁盘空间 ==="
df -h

echo "=== 内存使用 ==="
free -h

echo "=== 服务状态 ==="
docker compose ps 2>/dev/null || echo "Docker Compose 未运行"
sudo systemctl status crypto-backend 2>/dev/null || echo "systemd 服务未配置"
```

---

**请将具体的错误信息发给我，我会帮你进一步诊断！**

