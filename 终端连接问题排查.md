# 终端连接问题排查指南

## 问题类型判断

"终端进不去"可能指以下几种情况：
1. **SSH 无法连接到服务器**
2. **Docker 容器无法进入**
3. **本地终端无法使用**
4. **服务器无法访问**

## 快速诊断

### 1. 检查本地终端

```bash
# 测试本地终端是否正常
echo "测试终端"
pwd
ls -la
```

### 2. 检查服务器连接

```bash
# 测试服务器是否在线（替换为你的服务器IP）
ping -c 3 8.216.33.6

# 测试 SSH 端口是否开放
nc -zv 8.216.33.6 22
# 或
telnet 8.216.33.6 22
```

### 3. 检查 Docker 容器状态

```bash
# 如果是在本地，检查 Docker 是否运行
docker ps

# 如果是在服务器上，SSH 连接后检查
ssh root@8.216.33.6 "docker ps"
```

## 常见问题及解决方案

### 问题1: SSH 连接被拒绝

**症状**：
```
ssh: connect to host 8.216.33.6 port 22: Connection refused
```

**解决方案**：

1. **检查服务器 SSH 服务是否运行**
```bash
# 在服务器上执行（如果能通过其他方式访问）
systemctl status sshd
# 或
service ssh status

# 如果未运行，启动服务
sudo systemctl start sshd
sudo systemctl enable sshd
```

2. **检查防火墙设置**
```bash
# Ubuntu/Debian
sudo ufw status
sudo ufw allow 22/tcp

# CentOS/RHEL
sudo firewall-cmd --list-all
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

3. **检查 SSH 配置**
```bash
# 在服务器上检查
sudo cat /etc/ssh/sshd_config | grep -E "(Port|PermitRootLogin|PasswordAuthentication)"
```

### 问题2: SSH 连接超时

**症状**：
```
ssh: connect to host 8.216.33.6 port 22: Operation timed out
```

**解决方案**：

1. **检查网络连通性**
```bash
ping 8.216.33.6
traceroute 8.216.33.6
```

2. **检查服务器是否在线**
   - 登录云服务器控制台检查实例状态
   - 检查安全组规则是否允许 SSH 端口

3. **尝试使用不同端口**
```bash
# 如果 SSH 配置了非标准端口
ssh -p 2222 root@8.216.33.6
```

### 问题3: Docker 容器无法进入

**症状**：
```
docker exec -it container_name /bin/bash
# 无响应或报错
```

**解决方案**：

1. **检查容器是否运行**
```bash
docker ps
docker ps -a  # 查看所有容器
```

2. **检查容器状态**
```bash
docker inspect container_name | grep -A 10 "State"
```

3. **尝试不同的 shell**
```bash
# 如果 /bin/bash 不存在，尝试 /bin/sh
docker exec -it container_name /bin/sh

# 或尝试其他 shell
docker exec -it container_name /usr/bin/bash
```

4. **重启容器**
```bash
docker restart container_name
docker exec -it container_name /bin/bash
```

### 问题4: 权限被拒绝

**症状**：
```
Permission denied (publickey,password)
```

**解决方案**：

1. **检查 SSH 密钥**
```bash
# 使用密钥文件
ssh -i ~/.ssh/id_rsa root@8.216.33.6

# 检查密钥权限
chmod 600 ~/.ssh/id_rsa
```

2. **使用密码登录**
```bash
ssh -o PreferredAuthentications=password root@8.216.33.6
```

3. **重置服务器密码**（通过云控制台）

### 问题5: 磁盘空间不足导致服务异常

**症状**：
- SSH 连接后无法执行命令
- 服务无法启动
- 数据库操作失败

**解决方案**：

1. **检查磁盘空间**
```bash
df -h
du -sh /* | sort -hr | head -10
```

2. **清理空间**
```bash
# 清理 Docker
docker system prune -a

# 清理日志
journalctl --vacuum-time=7d

# 清理临时文件
rm -rf /tmp/*
rm -rf /var/tmp/*
```

## 一键诊断脚本

创建诊断脚本 `diagnose_connection.sh`：

```bash
#!/bin/bash

SERVER_IP="${1:-8.216.33.6}"
SSH_USER="${2:-root}"

echo "=== 终端连接诊断 ==="
echo "服务器: $SSH_USER@$SERVER_IP"
echo ""

# 颜色定义
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 1. 测试网络连通性
echo "1. 测试网络连通性..."
if ping -c 3 -W 2 $SERVER_IP &> /dev/null; then
    echo -e "${GREEN}✓ 服务器可达${NC}"
else
    echo -e "${RED}✗ 服务器不可达${NC}"
    echo "   可能原因：服务器离线、IP错误、网络问题"
fi
echo ""

# 2. 测试 SSH 端口
echo "2. 测试 SSH 端口 (22)..."
if timeout 5 bash -c "echo >/dev/tcp/$SERVER_IP/22" 2>/dev/null; then
    echo -e "${GREEN}✓ SSH端口开放${NC}"
else
    echo -e "${RED}✗ SSH端口关闭或无法访问${NC}"
    echo "   可能原因：SSH服务未运行、防火墙阻止、端口被修改"
fi
echo ""

# 3. 测试 SSH 连接
echo "3. 测试 SSH 连接..."
if ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP echo "连接成功" 2>/dev/null; then
    echo -e "${GREEN}✓ SSH连接成功${NC}"
else
    echo -e "${RED}✗ SSH连接失败${NC}"
    echo "   尝试详细连接信息..."
    ssh -v -o ConnectTimeout=5 $SSH_USER@$SERVER_IP echo "test" 2>&1 | grep -E "(Connecting|Authenticating|Connection|Permission|refused|closed)" | head -5
fi
echo ""

# 4. 检查 Docker（如果能连接）
echo "4. 检查 Docker 容器状态..."
if ssh -o ConnectTimeout=5 $SSH_USER@$SERVER_IP "docker ps" 2>/dev/null; then
    echo -e "${GREEN}✓ Docker 服务正常${NC}"
    echo ""
    echo "运行中的容器："
    ssh -o ConnectTimeout=5 $SSH_USER@$SERVER_IP "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'" 2>/dev/null
else
    echo -e "${YELLOW}⚠ 无法检查 Docker（可能需要先解决 SSH 连接问题）${NC}"
fi
echo ""

# 5. 检查磁盘空间（如果能连接）
echo "5. 检查磁盘空间..."
if ssh -o ConnectTimeout=5 $SSH_USER@$SERVER_IP "df -h" 2>/dev/null; then
    echo -e "${GREEN}✓ 磁盘空间检查完成${NC}"
else
    echo -e "${YELLOW}⚠ 无法检查磁盘空间${NC}"
fi
echo ""

echo "=== 诊断完成 ==="
```

使用方法：
```bash
chmod +x diagnose_connection.sh
./diagnose_connection.sh 8.216.33.6 root
```

## 紧急恢复方案

### 方案1: 通过云控制台访问

1. **登录云服务器控制台**（阿里云、腾讯云、AWS 等）
2. **使用 VNC 或 Web 终端**直接访问服务器
3. **检查服务状态**并修复问题

### 方案2: 重启服务

如果可以通过控制台访问：

```bash
# 重启 SSH 服务
sudo systemctl restart sshd

# 重启 Docker
sudo systemctl restart docker

# 重启容器
docker restart $(docker ps -q)
```

### 方案3: 检查日志

```bash
# SSH 日志
sudo tail -50 /var/log/auth.log
# 或
sudo journalctl -u sshd -n 50

# Docker 日志
docker logs container_name
docker logs --tail 50 container_name
```

## 预防措施

1. **定期备份**：定期备份重要数据和配置
2. **监控磁盘空间**：设置磁盘空间告警
3. **保持服务运行**：使用 systemd 或 supervisor 管理服务
4. **配置自动重启**：Docker 容器使用 `restart: unless-stopped`
5. **多路径访问**：配置多个 SSH 密钥或备用访问方式

## 获取帮助

如果以上方法都无法解决问题，请提供：

1. **错误信息**：完整的错误输出
2. **服务器信息**：IP、操作系统、云服务商
3. **操作步骤**：你执行的具体命令
4. **日志信息**：相关服务的日志
